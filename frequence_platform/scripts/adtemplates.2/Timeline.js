/* Copr. (c) 2011, 4Mads */
var Timeline=Class.extend({init:function(c,b,a){this._strName=c;this._mapEffects={};MySprite.prototype.setParams.call(this,b);while(a&&a.length)this.addEffect(a.pop())},getName:function(){return this._strName},setTemplate:function(a){this.frames=a._frames},addEffect:function(a){this._mapEffects[a.name]=a;this.dirty();return a},removeEffect:function(a){delete this._mapEffects[a];this.dirty()},dirty:function(){this._fDirty=true;this._rgEffects=null},clean:function(){if(!this._fDirty)return;var b=0,c=[];for(var e in this._mapEffects){var a=this._mapEffects[e];c.push(a);a.updateFrames(this._template.allFrames);var d=a.offset+a.duration;if(b<d)b=d}c.sort(function(b,c){var a=b.offset-c.offset;return!a?0:a<0?-1:1});this._rgEffects=c;this._duration=b;this._fDirty=false},setLoop:function(b){var a=this.getPlaying();this._fLoop=b;!a&&this.getPlaying()&&this.playEffect()},setOffset:function(a){this.clean();if(a<0)a=0;else if(a>this._duration)a=this._duration;this._offset=a;this.killTimer();this.updateEffects()},setPaused:function(a){this._fPaused=a;if(a)this.killTimer();else{if(this._offset>=this._duration)this._offset=0;this._timeStart=this.getTimeNow()-this._timeStart;this.startTimer()}},getPlaying:function(){return!this._fPaused},start:function(){if(this._fPaused)this.setPaused(false);else{this.killTimer();this._timeStart=this.getTimeNow();this.startTimer()}},_timeStart:0,startTimer:function(){if(!this._idTimer){this._idTimer=1;window.requestAnimFrame(MySprite.bindCall(this,this.handleTimerTick))}},killTimer:function(){if(this._idTimer)this._idTimer=0},handleTimerTick:function(){var a=this.getTimeNow()-this._timeStart;this.clean();if(a>=this._duration)a=this._duration;this._offset=a;if(a>=this._duration)if(this._fLoop){if(this._loopDelay>0){this._loopDelay-=1;this.start()}}else this.killTimer();this.updateEffects();this._idTimer&&window.requestAnimFrame(MySprite.bindCall(this,this.handleTimerTick))},updateEffects:function(){this.clean();if(this._rgEffects){function c(a){var c=a.offset,b=a.duration,d=(e-c)/b;a.updatePosition(d)}for(var f=this._rgEffects.length,e=this.getOffset(),a=this._rgEffects.length-1;a>=0;a--){var d=this._rgEffects[a];if(d.offset<=e){for(var b=0;b<=a;b++)c(this._rgEffects[b]);break}c(d)}}MySprite.clean()},getTimeNow:function(){return(new Date).getTime()/1e3},setParam:MySprite.prototype.setParam},null,{loopDelay:3,loop:false,offset:0,paused:false,template:null})